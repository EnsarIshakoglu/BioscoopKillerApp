@using System.Linq
@using System.Security.Claims
@using System.Threading
@using BioscoopKillerApp.Controllers
@model MovieDetailViewModel
@Html.AntiForgeryToken()

@{
    ViewData["Title"] = "MovieDetails";
    var userId = -1;
}

<html>
<head>
    <style class="vjs-styles-defaults">
        .vdo-js {
            width: 300px;
            height: 150px;
        }

        .vjs-fluid {
            padding-top: 56.25%
        }
    </style>
    <title>Cinema A Entertainment Category Flat Bootstrap Responsive Website Template | Single :: w3layouts</title>
    @*<link href="~/lib/bootstrap/dist/css/MovieDetail/movie-detail-bootstrap.css" rel="stylesheet" type="text/css">*@
    <!-- Custom Theme files -->
    <link href="~/lib/bootstrap/dist/css/MovieDetail/movie-detail-style.css" rel="stylesheet" type="text/css" media="all">
    <!-- Custom Theme files -->
    <script async="" src="//www.google-analytics.com/analytics.js"></script>
    <script src="~/lib/bootstrap/dist/js/jquery.min.js"></script>
    <!-- Custom Theme files -->
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <meta name="keywords" content="Cinema Responsive web template, Bootstrap Web Templates, Flat Web Templates, Android Compatible web template,
Smartphone Compatible web template, free webdesigns for Nokia, Samsung, LG, Sony Ericsson, Motorola web design">
    <script type="application/x-javascript"> addEventListener("load", function() { setTimeout(hideURLbar, 0); }, false); function hideURLbar(){ window.scrollTo(0,1); } </script>
    <!--webfont-->
    <link href="//fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800" rel="stylesheet" type="text/css">
    <script defer="" async="" src="https://vdo.ai/core/w3layouts/vdo.ai.js"></script>
    <link id="_vdo_ads_css_5654_" rel="stylesheet" href="https://vdo.ai/core/dependencies_bs/vdo.min.css">
    <script async="" src="https://www.googletagmanager.com/gtag/js?id=UA-113932176-8"></script>
</head>
<body style="">
    <script src="//ajax.googleapis.com/ajax/libs/jquery/1.10.2/jquery.min.js"></script>
    <script src="//m.servedby-buysellads.com/monetization.js" type="text/javascript"></script>
    <script>
        (function () {
            if (typeof _bsa !== 'undefined' && _bsa) {
                // format, zoneKey, segment:value, options
                _bsa.init('flexbar', 'CKYI627U', 'placement:w3layoutscom');
            }
        })();
    </script>
    <script>
        (function () {
            if (typeof _bsa !== 'undefined' && _bsa) {
                // format, zoneKey, segment:value, options
                _bsa.init('fancybar', 'CKYDL2JN', 'placement:demo');
            }
        })();
    </script>
    <script>
        (function () {
            if (typeof _bsa !== 'undefined' && _bsa) {
                // format, zoneKey, segment:value, options
                _bsa.init('stickybox', 'CKYI653J', 'placement:w3layoutscom');
            }
        })();
    </script>
    <script>
        (function (v, d, o, ai) { ai = d.createElement("script"); ai.defer = true; ai.async = true; ai.src = v.location.protocol + o; d.head.appendChild(ai); })(window, document, "//vdo.ai/core/w3layouts/vdo.ai.js");
    </script><!-- Global site tag (gtag.js) - Google Analytics -->
    <script async="" src="https://www.googletagmanager.com/gtag/js?id=UA-125810435-1"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag() { dataLayer.push(arguments); }
        gtag('js', new Date());

        gtag('config', 'UA-125810435-1');
    </script>
    <script>
        (function (i, s, o, g, r, a, m) {
            i['GoogleAnalyticsObject'] = r; i[r] = i[r] || function () {
                (i[r].q = i[r].q || []).push(arguments)
            }, i[r].l = 1 * new Date(); a = s.createElement(o),
                m = s.getElementsByTagName(o)[0]; a.async = 1; a.src = g; m.parentNode.insertBefore(a, m)
        })(window, document, 'script', '//www.google-analytics.com/analytics.js', 'ga');
        ga('create', 'UA-30027142-1', 'w3layouts.com');
        ga('send', 'pageview');
    </script>

    <!-- header-section-starts -->
    <div class="full">

        <div class="main">
            <div class="single-content">

                <div class="reviews-section">
                    <div class="col-md-9 reviews-grids">
                        <div class="review">
                            <div class="movie-pic">
                                <a><img src=@Model.Movie.Poster alt=""></a>
                            </div>
                            <div class="review-info">
                                <a class="span">@Model.Movie.Title</a>
                                <div class="clearfix"></div>
                                <div class="clearfix"></div>
                                <p class="info">Actors:&nbsp;@string.Join(", ", @Model.Movie.Actors)</p>
                                <p class="info">Genre:&nbsp;@string.Join(", ", @Model.Movie.Genre)</p>
                                <p class="info">DURATION:&nbsp; @Model.Movie.Runtime</p>
                            </div>
                            <div class="clearfix"></div>
                        </div>
                        <!---728x90--->

                        <div class="single">
                        </div>

                        <div class="story-review">
                            <h4>SYNOPSIS:</h4>
                            <p>@Model.Movie.Plot</p>
                        </div>
                        <div class="story-review" style="border-top: 0;">
                            <h4>AVAILABLE TIMES:</h4>
                            @foreach (var airingMovie in @Model.AiringMovies)
                            {
                                <p><button type="button" style="margin: 5px;" onclick="location.href='@Url.Action("Index","Transaction", new {airingMovieId = airingMovie.Id, movieId = Model.Movie.Id})'" class="btn btn-danger">@airingMovie.AiringTime.GetValueOrDefault().Date.ToShortDateString() @airingMovie.AiringTime.GetValueOrDefault().ToShortTimeString() </button></p>
                            }

                        </div>
                        <!-- comments-section-starts -->
                        <!---728x90--->

                        <div class="comments-section" style="border-bottom: 3px solid #000">
                            <div class="comments-section-head">
                                <div class="comments-section-head-text">
                                    <h3>Comments</h3>
                                </div>
                                <div class="clearfix"></div>
                            </div>
                            <div class="comments-section-grids">
                                @foreach (var modelReview in Model.Reviews)
                                {
                                    @Html.Partial("Comment", modelReview);
                                }
                            </div>
                        </div>
                        <!-- comments-section-ends -->
                        @if (User.Identity.IsAuthenticated)
                        {
                            var sid = User.Claims.First(c => c.Type.Equals(ClaimTypes.Sid)).Value;
                            int.TryParse(sid, out userId);

                            <div class="reply-section">
                                <div class="reply-section-head">
                                    <div class="reply-section-head-text">
                                        <h3>Leave Reply</h3>
                                    </div>
                                </div>
                                <div class="blog-form">
                                    <form>
                                        <input type="text" class="text" value="@User.Identity.Name" disabled="disabled">
                                        <input type="text" class="text" id="reviewTitle" maxlength="100" placeholder="Subject">
                                        <textarea id="reviewText" placeholder="Review" maxlength="2000" ></textarea>
                                        <input type="button" id="postReview" value="POST">
                                    </form>
                                </div>
                            </div>
                        }
                        else
                        {
                            <div class="reply-section">
                                <div class="reply-section-head">
                                    <div class="reply-section-head-text">
                                        <a href="@Url.Action("LogIn", "User")"><i>Login to leave a reply</i></a>
                                    </div>
                                </div>
                            </div>
                        }


                        <div class="clearfix"></div>
                    </div>
                </div>

                <!---728x90--->


            </div>
            <div class="clearfix"></div>
        </div>
    </div>

    <div id="_vdo_ads_player_ai_"></div>
    <script id="_vdo_ads_deps_5654_" src="https://vdo.ai/core/dependencies_bs/vdo.min.js"></script>
    <script id="_vdo_ads_sdk_5654_" src="https://imasdk.googleapis.com/js/sdkloader/ima3.js"></script>
    <script id="_vdo_ads_frame_5654_" src="https://vdo.ai/core/w3layouts//adframe.js?k=44">
    </script>
</body>
</html>
@section Scripts {
    @{await Html.RenderPartialAsync("_ValidationScriptsPartial");}
    <script>
        $(function () {
            $('#postReview').on('click', postReview);
        });
    </script>

    <script>
    function postReview() {
        var reviewText = document.getElementById('reviewText').value;
        var reviewTitle = document.getElementById('reviewTitle').value;

        console.log(reviewText);

        var controllerPath = '@Url.Action("PostReview", "User")';

        var verificationToken = $("input[name='__RequestVerificationToken']").val();

        var user = {
            'Id': @userId
        };

        var movie = {
            'Id' : @Model.Movie.Id
        }

        var review = {
            'ReviewText': reviewText,
            'ReviewTitle' : reviewTitle,
            'Movie': movie,
            'User' : user
        };

        $.ajax({
            url: controllerPath,
            data: JSON.stringify(review),
            type: "POST",
            headers: {
                "RequestVerificationToken": verificationToken
            },
            contentType: "application/json; charset=utf-8",
            dataType: "json",
            success: function(result) {
                console.log("Success");

                if (result.validationMessage != null) {
                    alert(result.validationMessage);
                }

                refreshPage();
            },
            error: function () {
                console.log("Error");

                alert('Error creating review, please try again!');
            }
        });
    }
    </script>

    <script>
    function refreshPage() {
        window.location.href = '@Url.Action("MovieDetails", "Movie", Model.Movie)';
    }
    </script>
}